{% extends "layout.html" %}
{% block title %}Qu·∫£n l√Ω User{% endblock %}

{% block extra_head %}
<style>
  /* --- CSS GI·ªÆ NGUY√äN --- */
  :root {
    --primary-gradient: linear-gradient(135deg, #667eea, #764ba2);
    --success-gradient: linear-gradient(45deg, #28a745, #20c997);
    --warning-gradient: linear-gradient(45deg, #ffc107, #e0a800);
    --danger-gradient: linear-gradient(45deg, #dc3545, #bd2130);
    --info-gradient: linear-gradient(45deg, #17a2b8, #138496);
    --dark-bg: #1a1a1e;
    --dark-surface: #2a2a2e;
    --dark-border: rgba(255,255,255,0.1);
    --text-primary: #ffffff;
    --text-secondary: rgba(255,255,255,0.7);
  }

  .management-header { 
    background: var(--primary-gradient); 
    color: var(--text-primary); 
    padding: 2rem; 
    border-radius: 20px; 
    margin-bottom: 2rem; 
    position: relative; 
    overflow: hidden; 
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); 
  }
  
  .management-header::before { 
    content: ''; 
    position: absolute; 
    top: 0; left: 0; right: 0; bottom: 0; 
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>'); 
    pointer-events: none; 
  }

  .controls-container { 
    background: var(--dark-surface); 
    border-radius: 16px; 
    border: 1px solid var(--dark-border); 
    padding: 1.5rem; 
    margin-bottom: 2rem; 
    box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
  }

  .users-table-container { 
    background: var(--dark-surface); 
    border-radius: 20px; 
    border: 1px solid var(--dark-border); 
    overflow: hidden; 
    box-shadow: 0 15px 35px rgba(0,0,0,0.2); 
  }

  .users-table { margin-bottom: 0; }
  .users-table thead { 
    background: var(--primary-gradient); 
    position: sticky; 
    top: 0; 
    z-index: 10; 
  }
  .users-table thead th { 
    border: none; 
    padding: 1rem; 
    font-weight: 600; 
    color: white !important; 
  }

  .user-row { 
    transition: all 0.3s ease; 
    border-left: 4px solid transparent; 
    background: var(--dark-surface); 
  }
  .user-row:hover { 
    background: rgba(102, 126, 234, 0.1) !important; 
    border-left-color: #667eea; 
    transform: translateX(4px); 
  }
  .user-row td { 
    padding: 1rem; 
    vertical-align: middle; 
    border-color: var(--dark-border); 
  }

  .status-badge { 
    padding: 8px 16px; 
    border-radius: 25px; 
    font-size: 12px; 
    font-weight: 600; 
    text-transform: uppercase; 
    letter-spacing: 0.5px; 
    display: inline-flex; 
    align-items: center; 
    gap: 6px; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.2); 
  }
  .status-active { background: var(--success-gradient); color: white; }
  .status-blocked { background: var(--danger-gradient); color: white; }
  .status-pending { background: var(--warning-gradient); color: #000; }

  .action-btn { 
    background: none; 
    border: none; 
    padding: 8px 12px; 
    border-radius: 10px; 
    font-size: 14px; 
    font-weight: 500; 
    transition: all 0.3s ease; 
    margin: 0 3px; 
    position: relative; 
    overflow: hidden; 
    cursor: pointer; 
  }
  .action-btn:hover { 
    transform: translateY(-2px) scale(1.05); 
    box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
  }

  .user-avatar { 
    width: 40px; 
    height: 40px; 
    border-radius: 50%; 
    background: var(--primary-gradient); 
    display: inline-flex; 
    align-items: center; 
    justify-content: center; 
    color: white; 
    font-weight: 700; 
    font-size: 16px; 
    margin-right: 12px; 
    box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3); 
  }

  /* Modal Styles */
  .add-user-modal .modal-content { 
    border-radius: 20px; 
    border: none; 
    background-color: var(--dark-surface); 
    box-shadow: 0 25px 50px rgba(0,0,0,0.3); 
  }
  .add-user-modal .modal-header { 
    background: var(--primary-gradient); 
    color: white; 
    border-radius: 20px 20px 0 0; 
    border: none; 
    padding: 1.5rem 2rem; 
  }

  .form-control-dark, .form-select { 
    background-color: rgba(255,255,255,0.05); 
    border: 1px solid var(--dark-border); 
    color: var(--text-primary); 
    border-radius: 10px; 
    padding: 12px 16px; 
    transition: all 0.3s ease; 
  }
  .form-control-dark:focus, .form-select:focus { 
    background-color: rgba(255,255,255,0.08); 
    border-color: #667eea; 
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25); 
    color: var(--text-primary); 
  }

  .btn-primary { 
    background: var(--primary-gradient); 
    border: none; 
    padding: 12px 24px; 
    border-radius: 10px; 
    font-weight: 600; 
    transition: all 0.3s ease; 
  }
  .btn-primary:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); 
  }

  .confirm-modal-content {
    background-color: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.4);
  }
  .confirm-modal-header {
    border-bottom: 1px solid var(--dark-border);
    padding: 1.5rem;
  }
  .confirm-modal-title {
    color: #f85149;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .confirm-modal-body {
    padding: 1.5rem;
    color: var(--text-secondary);
  }
  .confirm-modal-footer {
    border-top: 1px solid var(--dark-border);
    padding: 1rem 1.5rem;
  }

  /* Button Gradient Colors */
  .btn-success { background: var(--success-gradient) !important; border: none; }
  .btn-warning { background: var(--warning-gradient) !important; border: none; }
  .btn-danger { background: var(--danger-gradient) !important; border: none; }
  .btn-info { background: var(--info-gradient) !important; border: none; }

  .btn-success:hover, .btn-warning:hover, .btn-danger:hover, .btn-info:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  }

  /* Navigation and Pagination */
  .nav-tabs { 
    border-bottom: 2px solid var(--dark-border); 
    margin-bottom: 2rem; 
  }
  .nav-tabs .nav-link { 
    background: none; 
    border: none; 
    color: var(--text-secondary); 
    padding: 12px 24px; 
    border-radius: 10px 10px 0 0; 
    transition: all 0.3s ease; 
  }
  .nav-tabs .nav-link.active { 
    background: var(--primary-gradient); 
    color: white; 
  }

  .pagination-dark .page-link { 
    background-color: var(--dark-surface); 
    border-color: var(--dark-border); 
    color: var(--text-secondary); 
  }
  .pagination-dark .page-link:hover { 
    background-color: rgba(102, 126, 234, 0.2); 
    color: var(--text-primary); 
  }
  .pagination-dark .page-item.active .page-link { 
    background: var(--primary-gradient); 
    border-color: #667eea; 
    color: white; 
  }
  .pagination-dark .page-item.disabled .page-link { 
    background-color: var(--dark-surface); 
    color: rgba(255,255,255,0.3); 
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .btn-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .btn-group .btn {
      margin: 0;
      width: 100%;
    }
  }
</style>
{% endblock %}

{% block content %}
<div id="js-flash-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

<div class="container-fluid py-4">
    <div class="management-header">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
            <div>
                <h2 class="mb-2"><i class="fa-solid fa-users-gear"></i> Qu·∫£n l√Ω User</h2>
                <p class="mb-0 opacity-75">Qu·∫£n l√Ω t√†i kho·∫£n ng∆∞·ªùi d√πng v√† ph√¢n quy·ªÅn h·ªá th·ªëng</p>
            </div>
            <button type="button" class="btn btn-light mt-3 mt-md-0" data-bs-toggle="modal" data-bs-target="#addUserModal">
                <i class="fa-solid fa-user-plus"></i> Th√™m User M·ªõi
            </button>
        </div>
    </div>

    {% include 'admin/_nav.html' %}

    <div class="controls-container d-flex justify-content-between align-items-center mb-4">
        <form method="GET" action="{{ url_for('admin.admin_manage') }}" class="d-flex gap-2 w-100">
            <input type="text" name="q" class="form-control form-control-dark" placeholder="T√¨m theo username ho·∫∑c email..." value="{{ search_query or '' }}">
            <button type="submit" class="btn btn-primary flex-shrink-0"><i class="fa-solid fa-search"></i> T√¨m</button>
        </form>
    </div>

    <div class="users-table-container">
        <div class="table-responsive">
            <table class="table users-table table-dark table-hover mb-0" id="usersTable">
                <thead>
                    <tr>
                        <th><i class="fa-solid fa-user me-2"></i>User</th>
                        <th><i class="fa-solid fa-shield me-2"></i>Vai tr√≤</th>
                        <th class="text-center"><i class="fa-solid fa-signal me-2"></i>Tr·∫°ng th√°i</th>
                        <th class="text-center"><i class="fa-solid fa-calendar me-2"></i>Ng√†y t·∫°o</th>
                        <th class="text-center"><i class="fa-solid fa-cogs me-2"></i>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr class="user-row">
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="user-avatar">{{ user.username[0].upper() }}</div>
                                <div>
                                    <div class="fw-bold">{{ user.username }}</div>
                                    <small class="text-muted">{{ user.email or 'No Email' }}</small>
                                </div>
                            </div>
                        </td>
                        <td>{{ user.role|title }}</td>
                        <td class="text-center">
                            <span class="status-badge status-{{ user.status }}">
                                <i class="fa-solid fa-{{ 'check-circle' if user.status == 'active' else 'lock' if user.status == 'blocked' else 'clock' }}"></i>
                                {{ 'Ho·∫°t ƒë·ªông' if user.status == 'active' else 'B·ªã ch·∫∑n' if user.status == 'blocked' else 'Ch·ªù duy·ªát' }}
                            </span>
                        </td>
                        <td class="text-center">
                            <small class="text-muted">{{ user.created_at.strftime('%d/%m/%Y') if user.created_at else 'N/A' }}</small>
                        </td>
                        <td class="text-center">
                            {% if user.role != 'admin' %}
                                <div class="btn-group">
                                    {% if user.status == 'pending' %}
                                        <button type="button" class="btn btn-sm btn-success"
                                                onclick="showActionModal('{{ url_for('admin.change_user_status', action='approve', username=user.username) }}', 'X√°c nh·∫≠n Duy·ªát', 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën k√≠ch ho·∫°t t√†i kho·∫£n cho <strong>{{ user.username }}</strong> kh√¥ng?', 'btn-success', 'C√≥, duy·ªát')">
                                            <i class="fa-solid fa-check"></i> Duy·ªát
                                        </button>
                                    {% elif user.status == 'active' %}
                                        <button type="button" class="btn btn-sm btn-warning text-dark"
                                                onclick="showActionModal('{{ url_for('admin.change_user_status', action='block', username=user.username) }}', 'X√°c nh·∫≠n Kh√≥a', 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën kh√≥a t√†i kho·∫£n c·ªßa <strong>{{ user.username }}</strong> kh√¥ng? H·ªç s·∫Ω kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p.', 'btn-warning text-dark', 'C√≥, kh√≥a')">
                                            <i class="fa-solid fa-user-lock"></i> Kh√≥a
                                        </button>
                                    {% elif user.status == 'blocked' %}
                                        <button type="button" class="btn btn-sm btn-info"
                                                onclick="showActionModal('{{ url_for('admin.change_user_status', action='unblock', username=user.username) }}', 'X√°c nh·∫≠n M·ªü kh√≥a', 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën m·ªü kh√≥a t√†i kho·∫£n cho <strong>{{ user.username }}</strong> kh√¥ng?', 'btn-info', 'M·ªü kh√≥a')">
                                            <i class="fa-solid fa-unlock"></i> M·ªü kh√≥a
                                        </button>
                                    {% endif %}
                                    
                                    <button type="button" class="btn btn-sm btn-danger"
                                            onclick="showDeleteModal('{{ url_for('admin.delete_user', user_id=user.id) }}', '{{ user.username }}')">
                                        <i class="fa-solid fa-trash"></i> X√≥a
                                    </button>
                                </div>
                            {% else %}
                                <span class="text-muted"><i class="fa-solid fa-crown"></i> Admin</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center p-5">
                            <i class="fa-solid fa-user-slash fa-2x mb-3 text-muted"></i>
                            <h5 class="mb-0">Kh√¥ng t√¨m th·∫•y user n√†o.</h5>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% if total_pages > 1 %}
    <nav aria-label="Page navigation" class="mt-4 d-flex justify-content-center">
        <ul class="pagination pagination-dark">
            <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('admin.admin_manage', page=page-1, q=search_query) }}">Tr∆∞·ªõc</a>
            </li>
            {% for p in range(1, total_pages + 1) %}
            <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('admin.admin_manage', page=p, q=search_query) }}">{{ p }}</a>
            </li>
            {% endfor %}
            <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('admin.admin_manage', page=page+1, q=search_query) }}">Sau</a>
            </li>
        </ul>
    </nav>
    {% endif %}
</div>

<div class="modal fade add-user-modal" id="addUserModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fa-solid fa-user-plus"></i> Th√™m User M·ªõi</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin.add_user') }}" id="addUserForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label"><i class="fa-solid fa-user"></i> Username</label>
                        <input type="text" name="username" class="form-control form-control-dark" placeholder="T·ªëi thi·ªÉu 3 k√Ω t·ª±" required minlength="3">
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><i class="fa-solid fa-lock"></i> Password</label>
                        <input type="password" name="password" class="form-control form-control-dark" placeholder="T·ªëi thi·ªÉu 8 k√Ω t·ª±" required minlength="8">
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><i class="fa-solid fa-envelope"></i> Email (T√πy ch·ªçn)</label>
                        <input type="email" name="email" class="form-control form-control-dark" placeholder="vidu@email.com">
                        <div class="form-text text-muted">N·∫øu c√≥ email, user s·∫Ω d√πng OTP khi ƒëƒÉng nh·∫≠p.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><i class="fa-solid fa-shield"></i> Vai tr√≤</label>
                        <select name="role" class="form-select form-control-dark">
                            <option value="user" selected>üë§ User - Ng∆∞·ªùi d√πng th∆∞·ªùng</option>
                            <option value="admin">üëë Admin - Qu·∫£n tr·ªã vi√™n</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fa-solid fa-times"></i> H·ªßy</button>
                    <button type="submit" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Th√™m User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="actionConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content confirm-modal-content">
            <div class="modal-header confirm-modal-header">
                <h5 class="modal-title" id="actionModalTitle"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body confirm-modal-body" id="actionModalBody"></div>
            <div class="modal-footer confirm-modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fa-solid fa-times me-1"></i> H·ªßy
                </button>
                <form id="actionForm" method="POST" action="">
                    <button type="submit" class="btn" id="actionModalConfirmBtn"></button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content confirm-modal-content">
            <div class="modal-header confirm-modal-header">
                <h5 class="modal-title confirm-modal-title">
                    <i class="fa-solid fa-trash"></i> X√°c nh·∫≠n X√≥a User
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body confirm-modal-body" id="deleteModalBody"></div>
            <div class="modal-footer confirm-modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fa-solid fa-times me-1"></i> H·ªßy
                </button>
                <form id="deleteUserForm" method="POST" action="">
                    <button type="submit" class="btn btn-danger">
                        <i class="fa-solid fa-trash me-1"></i> X√≥a vƒ©nh vi·ªÖn
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// --- H√ÄM TH√îNG B√ÅO TOAST ---
function showToast(message, type = 'success') {
    const container = document.getElementById('js-flash-container');
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} shadow`;
    notification.style.marginBottom = '10px';
    notification.style.minWidth = '250px';
    notification.innerHTML = `<i class="fa-solid ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i> ${message}`;
    
    container.appendChild(notification);

    setTimeout(() => {
        notification.style.transition = "opacity 0.5s ease";
        notification.style.opacity = "0";
        setTimeout(() => notification.remove(), 500);
    }, 3000);
}

// --- X·ª¨ L√ù MODAL ---
function showActionModal(actionUrl, title, body, btnClass, btnText) {
    const modalEl = document.getElementById('actionConfirmModal');
    const modal = new bootstrap.Modal(modalEl);
    
    document.getElementById('actionModalTitle').innerHTML = `<i class="fa-solid fa-exclamation-triangle"></i> ${title}`;
    document.getElementById('actionModalBody').innerHTML = body;
    
    const confirmBtn = document.getElementById('actionModalConfirmBtn');
    confirmBtn.innerHTML = `<i class="fa-solid fa-check me-1"></i> ${btnText}`;
    confirmBtn.className = `btn ${btnClass}`;
    
    document.getElementById('actionForm').setAttribute('action', actionUrl);
    
    modal.show();
}

function showDeleteModal(actionUrl, username) {
    const modalEl = document.getElementById('confirmDeleteModal');
    const modal = new bootstrap.Modal(modalEl);
    
    document.getElementById('deleteModalBody').innerHTML = `
        B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a vƒ©nh vi·ªÖn ng∆∞·ªùi d√πng <strong>${username}</strong> kh√¥ng? 
        <br><br>
        <span class="text-danger">‚ö†Ô∏è H√†nh ƒë·ªông n√†y s·∫Ω x√≥a c·∫£ container v√† to√†n b·ªô file c·ªßa h·ªç.</span>
    `;
    document.getElementById('deleteUserForm').setAttribute('action', actionUrl);
    
    modal.show();
}

// Form validation
document.addEventListener('DOMContentLoaded', function () {
    const addUserForm = document.getElementById('addUserForm');
    if (addUserForm) {
        addUserForm.addEventListener('submit', function(e) {
            const username = this.querySelector('[name="username"]').value;
            const password = this.querySelector('[name="password"]').value;
            
            if (username.length < 3) {
                e.preventDefault();
                showToast('Username ph·∫£i c√≥ √≠t nh·∫•t 3 k√Ω t·ª±', 'danger'); // Thay alert
                return false;
            }
            
            if (password.length < 8) {
                e.preventDefault();
                showToast('Password ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±', 'danger'); // Thay alert
                return false;
            }
        });
    }
});
</script>
{% endblock %}